<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPS - 开票管理（交互原型）</title>
  <style>
    :root {
      --bg:#f7f8fa;--card:#fff;--text:#1f2d3d;--muted:#5c6b77;--primary:#2e7d32;--primary-600:#256e2a;
      --warn:#ff8f00;--border:#e6e8eb;--decision:#fff3e0;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'PingFang SC','Hiragino Sans GB','Microsoft Yahei',sans-serif}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:#fff;border-right:1px solid var(--border);padding:16px}
    .brand{font-weight:700;font-size:16px;margin-bottom:12px;color:#0277bd}
    .nav-link{display:block;padding:8px 10px;color:var(--text);text-decoration:none;border-radius:6px;margin-bottom:4px}
    .nav-link.active,.nav-link:hover{background:#f1f5f9}
    .content{padding:20px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--border);background:#fff;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary-600)}
    .btn.warn{background:var(--warn);color:#fff}
    table{width:100%;border-collapse:collapse} th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted)}
    .status{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eceff1;color:#607d8b}
    .status.success{background:#e8f5e9;color:#2e7d32}
    .status.wait{background:#fff3e0;color:#ef6c00}
    .legend{font-size:12px;color:#5c6b77}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:min(860px,100%);background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--text)}
    .log{background:#0b1020;color:#e5e7eb;border-radius:10px;padding:12px;font-family:ui-monospace,Menlo,monospace;font-size:12px;height:160px;overflow:auto}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">BPS</div>
      <a class="nav-link" href="javascript:void(0)">商户管理</a>
      <a class="nav-link" href="javascript:void(0)">店铺管理</a>
      <a class="nav-link" href="javascript:void(0)">订单管理</a>
      <a class="nav-link" href="javascript:void(0)">商品管理</a>
      <a class="nav-link" href="javascript:void(0)">选品库</a>
      <a class="nav-link active" href="javascript:void(0)">开票管理</a>
    </aside>

    <main class="content">
      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:18px;">开票管理</h2>
          <div class="legend">选择订单 → 校验状态 → 编辑并提交开票 → 查看结果</div>
        </div>
      </div>

      <!-- 搜索筛选栏（参考截图） -->
      <div class="card" style="margin-bottom:12px;">
        <div class="actions" style="flex-wrap:wrap;gap:10px;">
          <div class="field" style="min-width:220px;flex:1;">
            <label class="label">按键类型</label>
            <select id="q-key-type">
              <option value="shopifyId">按Shopify 订单id</option>
              <option value="platformOrder">平台订单编号</option>
              <option value="orderId">订单ID</option>
              <option value="buyer">买家姓名</option>
              <option value="shop">店铺名称</option>
            </select>
          </div>
          <div class="field" style="width:120px;">
            <label class="label">匹配</label>
            <select id="q-op">
              <option value="eq">等于</option>
              <option value="contains">包含</option>
            </select>
          </div>
          <div class="field" style="min-width:260px;flex:2;">
            <label class="label">查询内容（可用逗号/空格分隔多值）</label>
            <input id="q-keyword" type="text" placeholder="双击打开批量查询（此处直接输入即可）" />
          </div>
          <div class="actions" style="align-self:flex-end;">
            <button class="btn" id="btn-q-reset">重置</button>
            <button class="btn warn" id="btn-q-search">搜索</button>
          </div>
        </div>
        <div class="actions" style="margin-top:8px;gap:10px;flex-wrap:wrap;">
          <div class="field" style="width:160px;">
            <label class="label">平台</label>
            <select id="q-platform">
              <option value="">全部</option>
              <option value="Shopify">Shopify</option>
            </select>
          </div>
          <div class="field" style="width:200px;">
            <label class="label">国家</label>
            <input id="q-country" type="text" placeholder="输入国家搜索" />
          </div>
          <div class="field" style="width:200px;">
            <label class="label">省份</label>
            <input id="q-province" type="text" placeholder="输入省份搜索（演示）" />
          </div>
          <div class="field" style="width:240px;">
            <label class="label">邮箱</label>
            <input id="q-email" type="text" placeholder="输入邮箱搜索（演示）" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="actions" style="justify-content:space-between;margin-bottom:10px;">
          <div class="actions">
            <button class="btn" id="btn-sync">从订单管理同步</button>
            <span class="legend">已选 <span id="sel-count">0</span> 条</span>
          </div>
          <div class="actions">
            <button class="btn" id="btn-clear">清空选择</button>
            <button class="btn warn" id="btn-validate">校验并开票</button>
          </div>
        </div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:36px;"><input type="checkbox" id="chk-all" /></th>
                <th>平台</th>
                <th>平台订单编号</th>
                <th>订单ID</th>
                <th>买家姓名</th>
                <th>国家</th>
                <th>店铺名称</th>
                <th>订单金额</th>
                <th>付款时间</th>
                <th>发货日期</th>
                <th>开票状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="order-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="log" id="log"></div>
      </div>
    </main>
  </div>

  <!-- 开票表单 + 常用信息选择 -->
  <div class="modal-backdrop" id="form-backdrop">
    <div class="modal">
      <h3 style="margin:0 0 8px 0;">编辑开票信息</h3>

      <!-- 常用信息选择区 -->
      <div class="card" style="padding:12px;margin-bottom:12px;background:#f9fafb;">
        <div class="actions" style="gap:12px;flex-wrap:wrap;">
          <div class="field" style="min-width:260px;flex:1;">
            <label class="label">常用信息</label>
            <select id="f-common-list"></select>
          </div>
          <button class="btn" id="btn-load-common">载入常用信息</button>
          <button class="btn" id="btn-save-common">保存为常用信息</button>
          <span class="legend">提示：载入后会覆盖表单当前内容</span>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label class="label">Company Name</label>
          <input id="f-company-name" type="text" placeholder="公司名称" />
        </div>
        <div class="field">
          <label class="label">Company Number</label>
          <input id="f-company-number" type="text" placeholder="统一社会信用代码/注册号" />
        </div>
        <div class="field" style="grid-column:1 / span 2;">
          <label class="label">Address</label>
          <input id="f-address" type="text" placeholder="注册地址（国家/省市区/详细地址）" />
        </div>
        <div class="field">
          <label class="label">Invoice Number</label>
          <input id="f-invoice-number" type="text" placeholder="例如：FP-000001" />
        </div>
        <div class="field">
          <label class="label">Date</label>
          <input id="f-date" type="date" />
        </div>
        <div class="field">
          <label class="label">Currency</label>
          <select id="f-currency">
            <option value="HK$">HK$</option>
            <option value="USD">$</option>
            <option value="CNY">CNY</option>
            <option value="EUR">€</option>
          </select>
        </div>
        <div class="field">
          <label class="label">金额预览</label>
          <input id="f-amount-preview" type="text" disabled />
        </div>
      </div>

      <div class="actions" style="justify-content:flex-end;margin-top:12px;">
        <button class="btn" id="btn-close-form">取消</button>
        <button class="btn primary" id="btn-submit-form">确认开票</button>
      </div>
    </div>
  </div>

  <!-- 已开票订单提示 -->
  <div class="modal-backdrop" id="confirm-backdrop">
    <div class="modal">
      <div class="card" style="background: var(--decision); border-style:dashed; margin-bottom:8px;">
        存在已开票订单，是否继续开票？
      </div>
      <div class="actions" style="justify-content:flex-end;">
        <button class="btn" id="btn-cancel-confirm">否，取消</button>
        <button class="btn warn" id="btn-continue-confirm">是，继续</button>
      </div>
    </div>
  </div>

  <script>
    // 订单（来自截图的5条）
    let orders = [
      { platform:'Shopify', platformOrder:'#1010', orderId:'64659533726699', buyer:'scale hyb', country:'United States', shop:'mabangtesttest02', amount:368.00, currency:'HK$', paidAt:'2025-09-23 11:00:24', shippedAt:'-', status:'none' },
      { platform:'Shopify', platformOrder:'#1617', orderId:'116047166818094', buyer:'BingAu User', country:'United States', shop:'mabangtesttest03', amount:1597.00, currency:'HK$', paidAt:'2025-09-19 20:17:37', shippedAt:'-', status:'none' },
      { platform:'Shopify', platformOrder:'#1612', orderId:'11604715667822', buyer:'BingAu User', country:'United States', shop:'mabangtesttest03', amount:1597.00, currency:'HK$', paidAt:'2025-09-19 20:16:37', shippedAt:'-', status:'success', lastInvoice:{no:'FP-000231', at:'2025-09-20 10:01:00'} },
      { platform:'Shopify', platformOrder:'#1618', orderId:'11604716650862', buyer:'BingAu User', country:'United States', shop:'mabangtesttest03', amount:1597.00, currency:'HK$', paidAt:'2025-09-19 20:17:38', shippedAt:'-', status:'none' },
      { platform:'Shopify', platformOrder:'#1671', orderId:'11608074092910', buyer:'wuliang liang', country:'United States', shop:'mabangtesttest03', amount:599.00, currency:'HK$', paidAt:'2025-09-22 18:58:04', shippedAt:'-', status:'fail' }
    ];

    // 常用信息库（示例）
    let commonInfos = [
      { id:'N-001', companyName:'Ecpro Brand Ltd', companyNumber:'BRN-ECPRO-0001', address:'Room 1101, Central Plaza, Hong Kong', currency:'HK$' },
      { id:'N-002', companyName:'SWIFT DIGITAL SOLUTION (LLC)', companyNumber:'LIC-SWIFT-LLC-0002', address:'Suite 200, Business Bay, Dubai, UAE', currency:'HK$' }
    ];

    let invoiceDB = [];

    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>Array.from(document.querySelectorAll(s));
    const logEl = qs('#log');

    function log(t){ const ts=new Date().toISOString().replace('T',' ').substring(0,19); logEl.textContent += '['+ts+'] '+t+'\\n'; logEl.scrollTop=logEl.scrollHeight; }
    function statusTag(s){ if(s==='success')return'<span class="status success">已开票</span>'; if(s==='wait')return'<span class="status wait">开票中</span>'; if(s==='fail')return'<span class="status wait">开票失败</span>'; return'<span class="status">未开票</span>'; }

    function getQuery(){
      const keyType = qs('#q-key-type') ? qs('#q-key-type').value : '';
      const op = qs('#q-op') ? qs('#q-op').value : 'eq';
      const keywordRaw = qs('#q-keyword') ? qs('#q-keyword').value.trim() : '';
      const keywords = keywordRaw ? keywordRaw.split(/[\s,]+/).filter(Boolean) : [];
      const platform = qs('#q-platform') ? qs('#q-platform').value : '';
      const country = qs('#q-country') ? qs('#q-country').value.trim() : '';
      const province = qs('#q-province') ? qs('#q-province').value.trim() : '';
      const email = qs('#q-email') ? qs('#q-email').value.trim() : '';
      return { keyType, op, keywords, platform, country, province, email };
    }

    function matchValue(val, op, keywords){
      if(keywords.length===0) return true;
      const v = String(val ?? '').toLowerCase();
      if(op==='eq') return keywords.some(k => v === String(k).toLowerCase());
      return keywords.some(k => v.includes(String(k).toLowerCase()));
    }

    function renderOrders(){
      const tbody = qs('#order-tbody');
      const q = getQuery();
      const list = orders.filter(o=>{
        // 平台/国家简单过滤
        if(q.platform && o.platform !== q.platform) return false;
        if(q.country && !String(o.country||'').toLowerCase().includes(q.country.toLowerCase())) return false;
        // 省份/邮箱演示字段，当前数据无，忽略但保留接口
        // 主键匹配
        let fieldVal = '';
        if(q.keyType==='shopifyId') fieldVal = o.orderId;
        else if(q.keyType==='platformOrder') fieldVal = o.platformOrder;
        else if(q.keyType==='orderId') fieldVal = o.orderId;
        else if(q.keyType==='buyer') fieldVal = o.buyer;
        else if(q.keyType==='shop') fieldVal = o.shop;
        return matchValue(fieldVal, q.op, q.keywords);
      });

      tbody.innerHTML = list.map(o=>`
        <tr data-id="${o.orderId}">
          <td><input type="checkbox" class="chk-row" /></td>
          <td>${o.platform}</td>
          <td>${o.platformOrder}</td>
          <td>${o.orderId}</td>
          <td>${o.buyer}</td>
          <td>${o.country}</td>
          <td>${o.shop}</td>
          <td>${o.currency} ${o.amount.toLocaleString()}</td>
          <td>${o.paidAt}</td>
          <td>${o.shippedAt}</td>
          <td>${statusTag(o.status)} ${o.status==='fail' ? '<span class="legend">可重试</span>':''}</td>
          <td><button class="btn" data-act="edit">开票</button></td>
        </tr>
      `).join('');
      updateSelCount();
    }
    function updateSelCount(){ qs('#sel-count').textContent = qsa('.chk-row:checked').length; }
    function getSelectedIds(){ return qsa('#order-tbody tr').filter(tr=>tr.querySelector('.chk-row').checked).map(tr=>tr.getAttribute('data-id')); }

    // 常用信息渲染与载入
    function renderCommonSelect(){
      const sel = qs('#f-common-list');
      sel.innerHTML = '<option value="">选择常用信息</option>' + commonInfos.map(c=>`<option value="${c.id}">${c.companyName}</option>`).join('');
    }
    function loadCommonToForm(id){
      const c = commonInfos.find(x=>x.id===id); if(!c) return;
      qs('#f-company-name').value = c.companyName || '';
      qs('#f-company-number').value = c.companyNumber || '';
      qs('#f-address').value = c.address || '';
      qs('#f-currency').value = c.currency || 'HK$';
      refreshAmountPreview();
      log('已载入常用信息：'+ c.companyName);
    }
    function saveCurrentToCommon(){
      const obj = {
        id: 'N-' + String(commonInfos.length+1).padStart(3,'0'),
        companyName: qs('#f-company-name').value.trim(),
        companyNumber: qs('#f-company-number').value.trim(),
        address: qs('#f-address').value.trim(),
        currency: qs('#f-currency').value
      };
      if(!obj.companyName || !obj.companyNumber){ alert('请至少填写 Company Name 与 Company Number'); return; }
      const dup = commonInfos.find(c=>c.companyName===obj.companyName && c.companyNumber===obj.companyNumber);
      if(!dup){ commonInfos.push(obj); renderCommonSelect(); log('已保存为常用信息：'+obj.companyName); }
    }

    // 表单逻辑
    let selectedOrdersCache = [];
    let currentCurrency = 'HK$';

    function openFormPrefill(selectedIds){
      selectedOrdersCache = selectedIds.map(id=>orders.find(o=>o.orderId===id)).filter(Boolean);
      const first = selectedOrdersCache[0];
      currentCurrency = first?.currency || 'HK$';
      qs('#f-company-name').value = first?.shop || '';
      qs('#f-company-number').value = '';
      qs('#f-address').value = first?.country ? (first.country + ' / (填写详细地址)') : '';
      qs('#f-invoice-number').value = 'FP-' + (Math.floor(Math.random()*900000)+100000);
      qs('#f-date').valueAsDate = new Date();
      qs('#f-currency').value = currentCurrency;
      renderCommonSelect();
      refreshAmountPreview();
      qs('#form-backdrop').style.display='flex';
    }
    function closeForm(){ qs('#form-backdrop').style.display='none'; }
    function openConfirm(){ qs('#confirm-backdrop').style.display='flex'; }
    function closeConfirm(){ qs('#confirm-backdrop').style.display='none'; }

    function refreshAmountPreview(){
      const sum = selectedOrdersCache.reduce((a,b)=>a + Number(b.amount||0), 0);
      qs('#f-amount-preview').value = (qs('#f-currency').value || 'HK$') + ' ' + sum.toLocaleString();
    }

    function bindEvents(){
      qs('#chk-all').addEventListener('change', e=>{ const on=e.target.checked; qsa('.chk-row').forEach(ch=>ch.checked=on); updateSelCount(); });
      document.addEventListener('change', e=>{ if(e.target.classList.contains('chk-row')) updateSelCount(); });
      qs('#btn-clear').addEventListener('click', ()=>{ qsa('.chk-row').forEach(ch=>ch.checked=false); qs('#chk-all').checked=false; updateSelCount(); });
      qs('#btn-sync').addEventListener('click', ()=> log('已与订单管理同步（模拟）'));

      // 搜索与重置
      if(qs('#btn-q-search')){
        qs('#btn-q-search').addEventListener('click', ()=>{ renderOrders(); log('已执行搜索筛选'); });
      }
      if(qs('#btn-q-reset')){
        qs('#btn-q-reset').addEventListener('click', ()=>{
          if(qs('#q-key-type')) qs('#q-key-type').value = 'shopifyId';
          if(qs('#q-op')) qs('#q-op').value = 'eq';
          if(qs('#q-keyword')) qs('#q-keyword').value = '';
          if(qs('#q-platform')) qs('#q-platform').value = '';
          if(qs('#q-country')) qs('#q-country').value = '';
          if(qs('#q-province')) qs('#q-province').value = '';
          if(qs('#q-email')) qs('#q-email').value = '';
          renderOrders();
        });
      }

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.getAttribute('data-act')==='edit'){
          const id = btn.closest('tr').getAttribute('data-id');
          openFormPrefill([id]); log('单笔开票：'+id);
        }
      });

      qs('#btn-validate').addEventListener('click', ()=>{
        const ids = getSelectedIds();
        if(ids.length===0){ alert('请先选择订单'); return; }
        const hasInvoiced = ids.some(id => (orders.find(o=>o.orderId===id)?.status)==='success');
        if(hasInvoiced){ openConfirm(); log('存在已开票订单，弹出确认'); } else { openFormPrefill(ids); }
      });
      qs('#btn-cancel-confirm').addEventListener('click', ()=>{ closeConfirm(); log('取消开票'); });
      qs('#btn-continue-confirm').addEventListener('click', ()=>{ closeConfirm(); openFormPrefill(getSelectedIds()); });

      // 常用信息交互
      qs('#btn-load-common').addEventListener('click', ()=>{ const id=qs('#f-common-list').value; if(id) loadCommonToForm(id); });
      qs('#btn-save-common').addEventListener('click', saveCurrentToCommon);

      // 表单交互
      qs('#f-currency').addEventListener('change', refreshAmountPreview);
      qs('#btn-close-form').addEventListener('click', closeForm);

      qs('#btn-submit-form').addEventListener('click', ()=>{
        const data = {
          companyName: qs('#f-company-name').value.trim(),
          companyNumber: qs('#f-company-number').value.trim(),
          address: qs('#f-address').value.trim(),
          invoiceNumber: qs('#f-invoice-number').value.trim(),
          date: qs('#f-date').value,
          currency: qs('#f-currency').value
        };
        if(!data.companyName || !data.companyNumber || !data.address || !data.invoiceNumber || !data.date){
          alert('请完整填写表单信息'); return;
        }
        closeForm();
        const ids = selectedOrdersCache.map(o=>o.orderId);
        orders = orders.map(o => ids.includes(o.orderId) ? { ...o, status:'wait' } : o);
        renderOrders();
        log('执行开票中...');

        setTimeout(()=>{
          ids.forEach(id=>{
            const success = Math.random()>0.05;
            const invNo = data.invoiceNumber;
            const now = new Date().toISOString().replace('T',' ').substring(0,19);
            invoiceDB.push({ orderId:id, invoiceNo:invNo, companyName:data.companyName, date:data.date, currency:data.currency, at:now, status:success?'success':'fail' });
            const idx = orders.findIndex(o=>o.orderId===id);
            if(idx>=0){
              orders[idx] = { ...orders[idx], status: success?'success':'fail', lastInvoice: success?{no:invNo, at:now}:orders[idx].lastInvoice };
            }
            log((success?'成功':'失败')+'：订单 '+id+' 发票 '+invNo);
          });
          renderOrders();
        }, 900);
      });
    }

    function init(){ renderOrders(); bindEvents(); log('开票管理已加载'); }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>